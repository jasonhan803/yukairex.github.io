<!DOCTYPE html>
<html>
<title>Nebulas Fantasy</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karma">
<link href="css/bootstrap.min.css" rel="stylesheet">
<style>
        body,h1,h2,h3,h4,h5,h6 {font-family: "Karma", sans-serif}
        .w3-bar-block .w3-bar-item {padding:20px}
        .buyPlayer {
            margin: auto;
            width: 50%;
            padding: 10px;
        }
        img {
            display:block;
            margin:auto;
        }
        .howtoplay{
            font-weight: bold;
        }
        .sectionTitle {
        font-weight: bold;
        padding: 20px; 
    }
</style>
<body>

        <!-- Sidebar (hidden by default)
        <nav class="w3-sidebar w3-bar-block w3-card w3-top w3-xlarge w3-animate-left" style="display:none;z-index:2;width:40%;min-width:300px" id="mySidebar">
                <a href="javascript:void(0)" onclick="w3_close()"
        class="w3-bar-item w3-button">Close</a>
        <a href="./index.html" onclick="w3_close()" class="w3-bar-item w3-button">Home</a>
        <a href="./index.html#howToPlay" onclick="w3_close()" class="w3-bar-item w3-button">How to Play</a>
        <a href="./index.html#about" onclick="w3_close()" class="w3-bar-item w3-button">About</a>
        <a href="./index.html#FAQ" onclick="w3_close()" class="w3-bar-item w3-button">FAQ</a>
        </nav> -->

    <div class="container">
        <div class="w3-white w3-xlarge" style="max-width:1200px;">
                <div class="w3-bar">
                        <a href="./index.html" class="w3-bar-item w3-button w3-mobile">Home</a>
                        <a href="./players.html" class="w3-bar-item w3-button w3-mobile">Portfolio</a>
                        <a href="./market.html" class="w3-bar-item w3-button w3-mobile">Market</a>
                        <a href="./about.html" class="w3-bar-item w3-button w3-mobile">About</a>
                        <a href="" id="contractAddress" class="w3-bar-item w3-button w3-mobile">Contract</a>
                </div>
        </div>

        <header class="w3-display-container w3-content w3-wide" style="max-width:1600px;min-width:500px" id="home">
            <img class="w3-image" src="./img/banner0.png">
            <!-- <div class="w3-display-bottomleft w3-padding-large w3-opacity">
                <h1 class="w3-xxlarge">Le Catering</h1>
            </div> -->
        </header>



        <div class=class="w3-main w3-content w3-padding" style="max-width:1200px;margin-top:100px">
            <h2 class="sectionTitle">Open Market, Players Available until 06/14</h2>

            <div id="playersRow" class="row">
                    <!-- PETS LOAD HERE -->
            </div>


            <div id="playersTemplate" style="display: none;">
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="panel panel-default panel-pet">
                    <div class="panel-heading">
                        <h3 id="name"></h3>
                    </div>
                    <div class="panel-body">
                        <img alt="140x140" data-src="holder.js/140x140" class="img-rounded img-center" style="width: 100%;margin-bottom: 10px" src="https://animalso.com/wp-content/uploads/2017/01/Golden-Retriever_6.jpg" data-holder-rendered="true">
                        <br>
                        <button class="btn btn-default" type="button" style="display:block;margin:auto">CLAIM</button>
                    </div>
                    </div>
                </div>
            </div>
        </div>


  <!-- Pagination -->
  <div class="w3-center w3-padding-32">
    <div class="w3-bar">
      <a href="#" class="w3-bar-item w3-button w3-hover-black">«</a>
      <a href="#" class="w3-bar-item w3-black w3-button">1</a>
      <a href="#" class="w3-bar-item w3-button w3-hover-black">2</a>
      <a href="#" class="w3-bar-item w3-button w3-hover-black">3</a>
      <a href="#" class="w3-bar-item w3-button w3-hover-black">4</a>
      <a href="#" class="w3-bar-item w3-button w3-hover-black">»</a>
    </div>
  </div>
  
 

<!-- End page content -->
</div>
<script src=./lib/jquery-3.3.1.min.js></script>
<script src= "bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src=../lib/nebpay.js></script>
<script src=../lib/nebulas.js></script>


<script>
        var nebulas = require("nebulas"),
        neb = new nebulas.Neb();
        var NebPay = require("nebpay");
        var nebPay = new NebPay();
        var serialNumber;
        Account = nebulas.Account;
        var account;

        var mainnetUrl = "https://pay.nebulas.io/api/mainnet/pay",
        testnetUrl = "https://pay.nebulas.io/api/pay";

        const contractAddress = "n1uk81ADePRoX1dVwrGK6RNN3SudSFmS3qX";
        const ownerAddress = "n1RQYWMLqy1twJhfYxPk4SFx7wdfeq31pMX";
        neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));
        $("#contractAddress").attr('href', 'https://explorer.nebulas.io/#/testnet/address/' + contractAddress).attr('target', "_blank");
        var chainId = 1001;// test net
        var callbackUrl = testnetUrl;
        var explorerTx = "https://explorer.nebulas.io/#/testnet/tx/";


        // //main net 
        // const contractAddress = "n1kU44RRFoFvQbe8A6FAHDCC5APnfn89m2P";
        // const ownerAddress = "n1bveJ8tkb1DDECgHvknRFZesJqeaL2iKNt";
        // $("#contractAddress").attr('href','https://explorer.nebulas.io/#/mainnet/address/'+contractAddress).attr("target","_blank");
        // neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));
        // var chainId = 1;// mainnet net
        // var callbackUrl = mainnetUrl;
        // //2ff9c00e3050f44dad190b1f5a6eb296ae6cdbed9007569db56fe2a054fc451c
        // var explorerTx = "https://explorer.nebulas.io/#/mainnet/tx/";
        // var explorer = "https://explorer.nebulas.io/#/address/";

   




                function claim(id){
                    console.log("in buy, id=",id)
                    var to = contractAddress;
                    var value = 0.01;// need to change
                    // var callFunction = "mint";
                    // var callArgs = "";
                    var callFunction = "mintPlayerById";
                    var callArgs = "[\"" + id + "\"]";
                    serialNumber = nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
                        listener: mintListener,        //设置listener, 处理交易返回信息
                    });
                }
            

                var txhash;

                function mintListener(resp) {
                    txhash = resp.txhash;
                    neb.api.getTransactionReceipt({
                        hash: resp.txhash
                    })
                        .then(function (receipt) {
                            console.log("receipt is:" + JSON.stringify(receipt))
                            setQuery = setInterval(function () {
                                setTxQuery();
                            }, 10000);
                        })
                }

                function setTxQuery() {
                neb.api.getTransactionReceipt({
                    hash: txhash
                })
                    .then(function (receipt) {
                        console.log(receipt)
                        if (receipt.status ==1){
                            console.log("tx success")
                            var playerId = JSON.parse(receipt.execute_result);
                            console.log(playerId)
                            clearInterval(setQuery);
                        }

                    if (receipt.status ==0){
                            console.log("tx fail")
                            clearInterval(setQuery);
                        }
                        
                    })
                    .catch(function (err) {
                        console.log("didn't get a receipt")
                    })
                }

        var claim;
        
        function init(){
            console.log("in the initial function");
            loadAllPlayers();
        }
        

        var totalPlayer;
        var temp = [];
        function loadAllPlayers(){
            $.getJSON('./players.json', function(data) {
                    var playersRow = $('#playersRow');
                    var playersTemplate = $('#playersTemplate');
                    playersRow.empty();
                    totalPlayer = data.length;
                    for (var i = 0; i < data.length; i ++) {
                        playersTemplate.find('#name').text(data[i].name);
                        playersTemplate.find('img').attr('src', data[i].picture);
                       // $('#claimButton').attr("id","claimButton"+i);
                       console.log("Button"+i)
                       playersTemplate.find('button').attr("id","Button"+i);
                      
                        // $('#claimButton'+i).click(function(){console.log('here')});
                        
                        //   playersTemplate.find('.pet-breed').text(data[i].breed);
                        //   playersTemplate.find('.pet-age').text(data[i].age);
                        //   playersTemplate.find('.pet-location').text(data[i].location);
                        //   playersTemplate.find('.btn-adopt').attr('data-id', data[i].id);
                        playersRow.append(playersTemplate.html());
                       
                    }
                    
                    
                    for(var i = 0;i<totalPlayer;i++){
                        $('#Button'+i).click(function() {
                            let temp = parseInt($(this).attr('id').substring(6));
                            console.log("here! "+ temp);
                            claim(temp);
                        })
                    }
            });
            
        }

    //     var tokenIds;   
    //     function loadPlayersByUser(address) {

    //         var testcontract;
    //         var callJSONs = {
    //             from: ownerAddress, // get address string
    //             to: contractAddress, // get the contract string
    //             value: "0",
    //             nonce: 0,
    //             gasPrice: "200000",
    //             gasLimit: "1000000",
    //             contract: testcontract
    //         }

    //         // get the token Id owned by the address
    //         testcontract = { "function": "getPlayersByOwner", "args": "[\"" + address + "\"]" };
    //         callJSONs.contract = testcontract;
    //         neb.api.call(callJSONs)
    //             .then(function (resp) {
    //                 tokenIds = JSON.parse(resp.result);
    //                 console.log(tokenIds);
                   
    //                 if (tokenIds.length>0){
    //                     $.getJSON('./players.json', function(data) {
    //                             var playersRow = $('#playersRow');
    //                             var playersTemplate = $('#playersTemplate');
                        
    //                             playersRow.empty();
    //                             for (i = 0; i < tokenIds.length; i ++) {
    //                             let id = tokenIds[i];
    //                             playersTemplate.find('#name').text(data[id].name);
    //                             playersTemplate.find('img').attr('src', data[id].picture);
    //                             //   playersTemplate.find('.pet-breed').text(data[i].breed);
    //                             //   playersTemplate.find('.pet-age').text(data[i].age);
    //                             //   playersTemplate.find('.pet-location').text(data[i].location);
    //                             //   playersTemplate.find('.btn-adopt').attr('data-id', data[i].id);
    //                             playersRow.append(playersTemplate.html());
    //                             }
    //                     });
    //                 }

    //             })
    //             .catch(function (err) {
    //                 console.log(JSON.stringify(err));
    //             });
    //    }

        


        
        $(window).load(function () {
            // executes when complete page is fully loaded, including all frames, objects and images
                // window.postMessage({
                // "target": "contentscript",
                // "data":{},
                // "method": "getAccount",
                // }, "*");
     
                // window.addEventListener('message', function(e) {
                //     if(!!e.data.data.account){
                //         account = e.data.data.account;
                //         console.log(account)
                        
                //     } // console.log(account)
                //     // else{
                //     //     alert('please load your NAS wallet')
                //     // }
                // });  
                
                init();    
        });
    </script>

</body>
</html>
