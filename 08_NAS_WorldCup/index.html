<!DOCTYPE html>
<html>
<title>Nebulas Fantasy</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karma">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/star.css" rel="stylesheet">

<style>
    body,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
        font-family: "Karma", sans-serif
    }

    .w3-bar-block .w3-bar-item {
        padding: 20px
    }

    .buyPlayer {
        margin: auto;
        width: 50%;
        padding: 10px;
    }

    img {
        display: block;
        margin: auto;
    }

    .howtoplay {
        font-weight: bold;
    }

    .sectionTitle {
        font-weight: bold;
        padding: 10px;
    }

    .navbar {
        display: inline-block;
        list-style-type: none;
    }

    .fa {
        cursor: pointer;
        font-size: 50px;
    }

    .fa-hide {
        display: none
    }
    .loader {
        border: 16px solid #e6d3d3;
        border-radius: 100%;
        border-top: 16px solid #3498db;
        width: 70px;
        height: 70px;
        animation: spin 2s linear infinite;
        display:none;
        margin:20px auto;
        }
    @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
    }
    /* Create two equal columns that floats next to each other */
    .column {
        float: left;
        width: 50%;
    }

    /* Clear floats after the columns */
    .row:after {
        content: "";
        display: table;
        clear: both;
    }

    /* ul {
    list-style-type: none;
    margin: 0;
    padding: 0;
    } */

    li{
    margin: 10px 0;
    }
</style>

<body>
    <div class="container">
        <div class="w3-white w3-xlarge" style="max-width:1200px;">
            <div class="w3-bar">
                <a href="./index.html" class="w3-bar-item w3-button w3-mobile">Home</a>
                <a href="./players.html" class="w3-bar-item w3-button w3-mobile">Portfolio</a>
                <a href="./market.html" class="w3-bar-item w3-button w3-mobile">Market</a>
                <a href="./about.html" class="w3-bar-item w3-button w3-mobile">About</a>
                <a href="" id="contractAddress" class="w3-bar-item w3-button w3-mobile">Contract</a>
                <span class="w3-bar-item w3-mobile" id="pool" style="float:right"></span>
            </div>
        </div>

        <header class="w3-display-container w3-content w3-wide" style="max-width:2000px;min-width:500px" id="home">
            <img class="w3-image" src="./img/banner0.png">
        </header>


        <div style="max-width:2000px;margin-top:50px">
            <h2 class="sectionTitle">Player Lottery</h2>
                <div class="row">
                    <div class="column">
                            <div class="buyPlayer">
                               
                                    <img class="img-center" id="randomPlayerCard" style="width:100%; height:100%;" src="./img/default card.png">
                                    <button id="claimButton" type="button" class="btn btn-primary" style="display: block; margin: 20px auto;">
                                        <h4> CLAIM</h4>
                                    </button>
                                    <!-- <div class="loader"></div> --> 
                            </div>
                    </div>
                    <div class="column">
                            <div class="board">
                                    <h4>
                                        <h2 style="text-align: center">Claim Your Player!</h2>
                                        <h2 style="text-align: center" id="currentPrice"></h2>
                                        <br>
                                        <ul>
                                            <li>Spend as low as 0.1 NAS to claim a random player (NRC721 token)</li>
                                            <li>Your player will be created with a random talent (1-5 stars)</li>
                                            <li>Your Payment will be deposited into the total prize pool directly</li>
                                            <li>Lottery price will increase 0.1NAS every 50 players </li>
                                            <li>Player accumulates points based on real world performance</li>
                                            <li>Free transfer your player anytime</li>
                                            <li>Reward will be distributed according to the player points rank (after World Cup ends)</li>
                                            <li>Desire a specific player? go to <a href="./market.html">open market</a> and pay a premium</li>
                                            <li>You need a Chrome Extension to load your <a href="https://chrome.google.com/webstore/detail/nebulas-wallet/magbanejlegnbcppjljfhnmfmghialkl">Nebulas Wallet</a> </li>
                                        </ul>
                                    </h4>
                            </div>
                    </div>
                </div>
       </div>
       

        <div class="modal fade" id="myModal" role="dialog">
            <div class="modal-dialog modal-md">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Nebulas Transaction</h3>
                </div>
                <div class="modal-body" >
                    <div>
                        
                        <h5 id="modal-status"></h5>
                        <div id="modal-txresult">
                            <h5> Talent: <span id="talent"  class="stars-container stars-5">★★★★★</span></h5>
                        </div>
                        <div class="loader" style="display:hide;margin:auto"></div>
                        
                    </div>  
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" id="confirm" data-dismiss="modal">OK</button>
                </div>
            </div>
            </div>
        </div>

        <!-- About Section -->
        <div  style="max-width:2000px;margin-top:50px">
            <h2 class="sectionTitle">How To Play</h2>
            <div class="row">
                <div class="col-md-4">
                    
                    <img class="img-center" src="./img/home/create.png">
                    <br/>
                    <h4 class="howtoplay"> Step1: Claim</h4>
                    <ul>
                        <li>claim a random or specific player with NAS </li>
                        <li>NAS will be deposited into prize pool </li>
                    </ul>
                  
                </div>
                <div class="col-md-4">
                    
                    <img class="img-center" src="./img/home/game.png">
                    <br/>
                    <h4 class="howtoplay">Step2: Score</h4>
                    <ul>
                        <li>your players score points based on real game performance </li>
                        <li>accumulate points with playing time, winning game and gol</li>
                    </ul>
                </div>
                <div class="col-md-4">
                    <img class="img-center" src="./img/home/win.png">
                    <br/>
                    <h4 class="howtoplay">Step3: Reward</h4>
                    <ul>
                        <li>top 50 players with highest points share prize pool </li>
                        <li>payment is distributed in NAS, by smart contract </li>
                    </ul>
                </div>
            </div>
        </div>


        <br/>
        <div  style="max-width:2000px;margin-top:50px">
            <h2 class="sectionTitle">What is Nebulas Fantasy?</h2>
            <br>
            <ul>
                    <li><h4> Nebulas Fantasy is a decentralized application that operates on the Nebulas Network.</h4></li>                  
                    <li><h4> We setup a fantasy platform for soccer fans to enjoy World Cup 2018 in a unique way </h4></li>
                    <li><h4> Soccer fans can own soccer players on Nebulas blockchain, gain points according to the players’ performance in the real World Cup matches, and win NAS as prize!</h4></li>
                    <li><h4> see <a href="./about.html">ABOUT</a> page for more information</h4></li>
                    <li><h4> contact nebulas.fantasy@gmail.com for further information</h4></li>
            </ul> 
        </div>

        <div  style="max-width:2000px;margin-top:50px">
        </div>
        <!-- End page content -->
    </div>
    <script src=./lib/jquery-3.3.1.min.js></script>
    <script src="bootstrap.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src=../lib/nebpay.js></script>
    <script src=../lib/nebulas.js></script>
    <script src='../lib/bignumber.min.js'></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src='address.js'></script>
    <script>

        var nebulas = require("nebulas"),
            neb = new nebulas.Neb();
        var NebPay = require("nebpay");
        var nebPay = new NebPay();
        var serialNumber;
        Account = nebulas.Account;

        var mainnetUrl = "https://pay.nebulas.io/api/mainnet/pay",
            testnetUrl = "https://pay.nebulas.io/api/pay";


        // const contractAddress =  require("address");//"n1wtjL3KMVNTV3gsWhJibnNMmr6HJHKwBW2";
        const ownerAddress = "n1RQYWMLqy1twJhfYxPk4SFx7wdfeq31pMX";
        neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));
        $("#contractAddress").attr('href', 'https://explorer.nebulas.io/#/testnet/address/' + contractAddress).attr('target', "_blank");
        var chainId = 1001;// test net
        var callbackUrl = testnetUrl;
        var explorerTx = "https://explorer.nebulas.io/#/testnet/tx/";


        // //main net 
        // const contractAddress = "n1kU44RRFoFvQbe8A6FAHDCC5APnfn89m2P";
        // const ownerAddress = "n1bveJ8tkb1DDECgHvknRFZesJqeaL2iKNt";
        // $("#contractAddress").attr('href','https://explorer.nebulas.io/#/mainnet/address/'+contractAddress).attr("target","_blank");
        // neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));
        // var chainId = 1;// mainnet net
        // var callbackUrl = mainnetUrl;
        // //2ff9c00e3050f44dad190b1f5a6eb296ae6cdbed9007569db56fe2a054fc451c
        // var explorerTx = "https://explorer.nebulas.io/#/mainnet/tx/";
        // var explorer = "https://explorer.nebulas.io/#/address/";

        function init() {
            var claim = $('#claimButton');
            claim.click(function(e) {
                e.preventDefault();
                buy();
            });
            getTotalPrize();
            getCurrentPrice();
        };



        function getCurrentPrice(){
            var testcontract;
                var callJSONs = {
                    from: ownerAddress, // get address string
                    to: contractAddress, // get the contract string
                    value: "0",
                    nonce: 0,
                    gasPrice: "200000",
                    gasLimit: "1000000",
                    contract: testcontract
                }

                // get the token Id owned by the address
                testcontract = { "function": "getDrawPrice", "args": "" };
                callJSONs.contract = testcontract;
                neb.api.call(callJSONs)
                .then(function (resp){
                    console.log(resp)
                    // $("#prize").show().text("Total prize pool:  " + String(parseInt(JSON.parse(resp.result)) / 1e18) + " NAS");
                    $("#currentPrice").show().text("current price: "+ String(parseFloat(JSON.parse(resp.result)))+ " NAS");
                    }   
                )
            }

        // check the prize pool
        function getTotalPrize() {
                var testcontract;
                var callJSONs = {
                    from: ownerAddress, // get address string
                    to: contractAddress, // get the contract string
                    value: "0",
                    nonce: 0,
                    gasPrice: "200000",
                    gasLimit: "1000000",
                    contract: testcontract
                }

                // get the token Id owned by the address
                testcontract = { "function": "getPrizePool", "args": "" };
                callJSONs.contract = testcontract;
                neb.api.call(callJSONs)
                .then(function (resp){
                    
                    // $("#prize").show().text("Total prize pool:  " + String(parseInt(JSON.parse(resp.result)) / 1e18) + " NAS");
                    $("#pool").show().text(String(parseInt(JSON.parse(resp.result)) / 1e18) + " NAS in pool");
                    }   
                )
        };

        function buy() {
                // read the price first
                var testcontract;
                var callJSONs = {
                    from: ownerAddress, // get address string
                    to: contractAddress, // get the contract string
                    value: "0",
                    nonce: 0,
                    gasPrice: "200000",
                    gasLimit: "1000000",
                    contract: testcontract
                }

                // get the token Id owned by the address
                testcontract = { "function": "getDrawPrice", "args": "" };
                callJSONs.contract = testcontract;
                neb.api.call(callJSONs)
                .then(function (resp){
                    var to = contractAddress;
                    var value = parseFloat(JSON.parse(resp.result));// need to change
                    var callFunction = "mint";
                    var callArgs = "";
                    console.log(value)
                    serialNumber = nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
                        listener: mintListener,        //设置listener, 处理交易返回信息
                    });
                
                    }   
                )
           
        }

        var txhash;

        function mintListener(resp) {
            txhash = resp.txhash;
            neb.api.getTransactionReceipt({
                hash: resp.txhash
            })
                .then(function (receipt) {
                    spinOn();
                    var playerCard = $('#randomPlayerCard');
                    playerCard.attr('src', "./img/default card.png");
                    console.log("receipt is:" + JSON.stringify(receipt))
                    setQuery = setInterval(function () {
                        setTxQuery();
                    }, 10000);
                })
        }

        function setTxQuery() {
            neb.api.getTransactionReceipt({
                hash: txhash
            })
                .then(function (receipt) {
                    console.log(receipt)
                    if (receipt.status == 1) {
                        console.log("tx success")
                        var result = JSON.parse(receipt.execute_result);
                        console.log(result.playerId)
                        getTotalPrize();
                        loadPlayerPicsById(result.playerId);
                        clearInterval(setQuery);
                        spinOff();

                        $.getJSON('./players.json', function (data) {
                            $("#modal-status").show().text("Congratulations! You just claimed " + data[result.playerId].name)
                            $("#talent").attr('class',showStars(result.talent));
                            $("#modal-txresult").show();
                        }); 
                    }

                    if (receipt.status == 0) {
                        console.log("tx fail")
                        $("#modal-status").show().text("Sorry, your transaction failed")
                        clearInterval(setQuery);
                        spinOff();
                    }

                })
                .catch(function (err) {
                    console.log("didn't get a receipt")
                })
        }

        function loadPlayerPicsById(id) {
            // Load pets.
            console.log(id);
            $.getJSON('./players.json', function (data) {
                var playerCard = $('#randomPlayerCard');
                playerCard.attr('src', data[id].picture);
            });
            
        }

        function spinOn() {
            $("#myModal").modal();
            $("#modal-status").show().text("Please wait for your transaction to be completed")
            $(".loader").css("display","block");
            $("#confirm").hide();
            $("#modal-txresult").hide();
            $("#modal").show();
        }

        function spinOff() {
            $(".loader").css("display","none");
            $("#confirm").show();
        }

      function showStars(number){
            return "stars-container stars-"+number;
        }


        $(window).load(function () {
            // executes when complete page is fully loaded, including all frames, objects and images
            init();
        });

    </script>

</body>

</html>