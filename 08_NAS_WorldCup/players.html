<!DOCTYPE html>
<html>
<title>Nebulas Fantasy</title>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://www.w3schools.com/w3css/4/w3.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Karma">
<link href="css/bootstrap.min.css" rel="stylesheet">
<link href="css/star.css" rel="stylesheet">
<style>
        body,h1,h2,h3,h4,h5,h6 {font-family: "Karma", sans-serif}
        .w3-bar-block .w3-bar-item {padding:20px}
        .buyPlayer {
            margin: auto;
            width: 50%;
            padding: 10px;
        }
        img {
            display:block;
            margin:auto;
        }
        .howtoplay{
            font-weight: bold;
        }
        .loader {
        border: 16px solid #e6d3d3;
        border-radius: 100%;
        border-top: 16px solid #3498db;
        width: 70px;
        height: 70px;
        animation: spin 2s linear infinite;
        display:none;
        margin:20px auto;
        }
    @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
    }
        </style>
<body>

        <!-- Sidebar (hidden by default)
        <nav class="w3-sidebar w3-bar-block w3-card w3-top w3-xlarge w3-animate-left" style="display:none;z-index:2;width:40%;min-width:300px" id="mySidebar">
                <a href="javascript:void(0)" onclick="w3_close()"
        class="w3-bar-item w3-button">Close</a>
        <a href="./index.html" onclick="w3_close()" class="w3-bar-item w3-button">Home</a>
        <a href="./index.html#howToPlay" onclick="w3_close()" class="w3-bar-item w3-button">How to Play</a>
        <a href="./index.html#about" onclick="w3_close()" class="w3-bar-item w3-button">About</a>
        <a href="./index.html#FAQ" onclick="w3_close()" class="w3-bar-item w3-button">FAQ</a>
        </nav> -->

    <div class="container">
        <div class="w3-white w3-xlarge" style="max-width:1200px;">
                <div class="w3-bar">
                        <a href="./index.html" class="w3-bar-item w3-button w3-mobile">Home</a>
                        <a href="./players.html" class="w3-bar-item w3-button w3-mobile">Portfolio</a>
                        <a href="./market.html" class="w3-bar-item w3-button w3-mobile">Market</a>
                        <a href="./about.html"  class="w3-bar-item w3-button w3-mobile">About</a>
                        <a href="" id="contractAddress" class="w3-bar-item w3-button w3-mobile">Contract</a>
                </div>
        </div>

        <header class="w3-display-container w3-content w3-wide" style="max-width:1600px;min-width:500px" id="home">
            <img class="w3-image" src="./img/banner0.png">
            <!-- <div class="w3-display-bottomleft w3-padding-large w3-opacity">
                <h1 class="w3-xxlarge">Le Catering</h1>
            </div> -->
            
            <div class="form-group" align="center" style="display:flex; float:right;width: 500px; margin:30px 30px; margin-left:auto; margin-right:auto">
                    <input class="form-control" type="text" id="address" placeholder="your NAS address">
                    <br>
                    <button id="check" class="btn btn-primary" onClick="check()" style="display: inline-block;">check</button>
                    <br> 
            </div>
            <div style="display:block; margin:20px auto;text-align: center"> <h3 id="title"></h3> </div>
        </header>



        <div class=class="w3-main w3-content w3-padding" style="max-width:1200px;margin-top:100px">

            <div id="playersRow" class="row">
                    <!-- PETS LOAD HERE -->
            </div>
            <div id="playersTemplate" style="display: none;">
                <div class="col-sm-6 col-md-4 col-lg-3">
                    <div class="panel panel-default panel-pet">
                    <div class="panel-heading">
                        <h3 id="name"></h3>
                    </div>
                    <div class="panel-body">
                        <img alt="140x140" data-src="holder.js/140x140" class="img-rounded img-center" style="width: 100%;" src="https://animalso.com/wp-content/uploads/2017/01/Golden-Retriever_6.jpg" data-holder-rendered="true">
                        <br/>
                        <strong>Talent</strong>:    <span id="talent"  class="stars-container stars-5">★★★★★</span><br/>
                       
                        <strong>Play Time</strong>: <span id="playtime"></span><br/>
                        <strong>WIN</strong>:       <span id="win"></span><br/>
                        <strong>GOAL</strong>:      <span id="goal"></span><br/>
                        <button class="btn btn-default" type="button" style="display:block;margin:auto" data-toggle="modal" data-target="#myModal">TRANSFER</button>
                            
                            <!-- Modal -->
         
                    </div>
                    </div>
                </div>
            </div>
        </div>


        <div class="modal fade" id="myModal" role="dialog">
                <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                            <button type="button" class="close" data-dismiss="modal">&times;</button>
                    <h2 class="modal-title">Transfer your player</h2>
                    </div>
                    <div class="modal-body" >
                        <div id="modal-input">
                            <h4>type in the address you'd like to transfer your player to</h4>
                            <input class="form-control" type="text" id="toAddress" placeholder="destination NAS address">
                        </div>
                        <div>
                                <h4 id="modal-status"></h4>
                                <div class="loader" style="display:hide;margin:auto"></div>
                        </div>  
                    </div>
                    <div class="modal-footer">
                    <button type="button" class="btn btn-default" id="confirm" >Confirm</button>
                    <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                    </div>
                </div>
                </div>
        </div>

  <!-- Pagination -->
  <div class="w3-center w3-padding-32">
    <div class="w3-bar">
      <a href="#" class="w3-bar-item w3-button w3-hover-black">«</a>
      <a href="#" class="w3-bar-item w3-black w3-button">1</a>
      <a href="#" class="w3-bar-item w3-button w3-hover-black">2</a>
      <a href="#" class="w3-bar-item w3-button w3-hover-black">3</a>
      <a href="#" class="w3-bar-item w3-button w3-hover-black">4</a>
      <a href="#" class="w3-bar-item w3-button w3-hover-black">»</a>
    </div>
  </div>
  
 

<!-- End page content -->
</div>
<script src=./lib/jquery-3.3.1.min.js></script>
<script src= "bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<script src=../lib/nebpay.js></script>
<script src=../lib/nebulas.js></script>


<script>
        var nebulas = require("nebulas"),
        neb = new nebulas.Neb();
        var NebPay = require("nebpay");
        var nebPay = new NebPay();
        var serialNumber;
        Account = nebulas.Account;
        var account;

        var mainnetUrl = "https://pay.nebulas.io/api/mainnet/pay",
        testnetUrl = "https://pay.nebulas.io/api/pay";

        const contractAddress = "n1uk81ADePRoX1dVwrGK6RNN3SudSFmS3qX";
        const ownerAddress = "n1RQYWMLqy1twJhfYxPk4SFx7wdfeq31pMX";
        neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));
        $("#contractAddress").attr('href', 'https://explorer.nebulas.io/#/testnet/address/' + contractAddress).attr('target', "_blank");
        var chainId = 1001;// test net
        var callbackUrl = testnetUrl;
        var explorerTx = "https://explorer.nebulas.io/#/testnet/tx/";


        // //main net 
        // const contractAddress = "n1kU44RRFoFvQbe8A6FAHDCC5APnfn89m2P";
        // const ownerAddress = "n1bveJ8tkb1DDECgHvknRFZesJqeaL2iKNt";
        //  $("#contractAddress").attr('href','https://explorer.nebulas.io/#/mainnet/address/'+contractAddress).attr("target","_blank");
        // neb.setRequest(new nebulas.HttpRequest("https://mainnet.nebulas.io"));
        // var chainId = 1;// mainnet net
        // var callbackUrl = mainnetUrl;
        // //2ff9c00e3050f44dad190b1f5a6eb296ae6cdbed9007569db56fe2a054fc451c
        // var explorerTx = "https://explorer.nebulas.io/#/mainnet/tx/";
        // var explorer = "https://explorer.nebulas.io/#/address/";
   
        function check() {
            var address = $('#address').val().trim();
            if (address.substring(0, 2) !== "n1" || address.length !== 35) {
                alert('Check your address!')
                return;
            } else {
                account = address;
                $("#title").hide();
                // checkAddressTokens(account);
                console.log(account);
                init();
            }
        }


        // function checkAddressTokens(address) {
        //         var testcontract;
        //         var callJSONs = {
        //             from: ownerAddress, // get address string
        //             to: contractAddress, // get the contract string
        //             value: "0",
        //             nonce: 0,
        //             gasPrice: "200000",
        //             gasLimit: "1000000",
        //             contract: testcontract
        //         }

        //         // get the token Id owned by the address
        //         testcontract = { "function": "balanceOf", "args": "[\"" + address + "\"]" };
        //         callJSONs.contract = testcontract;
        //         neb.api.call(callJSONs)
        //         .then(function (resp){
        //             console.log("resp is"+resp.result);
        //             $("#title").show().text("currently you own " + resp.result + " players");
        //             }   
        //         )
        // }



//         function buy() {
//             var to = contractAddress;
//             var value = 0;// need to change
//             var callFunction = "mint";
//             var callArgs = "";
//             serialNumber = nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
//                 listener: mintListener,        //设置listener, 处理交易返回信息
//             });
//         }

//       

        function init(){
            console.log("in the initial function");
            if (account!=="undefined"){
                $('#title').hide();
                loadPlayersByUser(account);
            }
        }


        var tokenIds; 
        var info;
        var playerInfo = [];

        function loadPlayersByUser(address) {
            var testcontract;
            var callJSONs = {
                from: ownerAddress, // get address string
                to: contractAddress, // get the contract string
                value: "0",
                nonce: 0,
                gasPrice: "200000",
                gasLimit: "1000000",
                contract: testcontract
            }

            // get the token Id owned by the address
            testcontract = { "function": "getPlayersByOwner", "args": "[\"" + address + "\"]" };
            callJSONs.contract = testcontract;
            neb.api.call(callJSONs)
                .then(
                    function (resp) {
                        tokenIds = JSON.parse(resp.result);
                        console.log(tokenIds);
                        // $("#title").show().text("Currently,you own " + tokenIds.length + " players");
                        var testcontract;
                        var callJSONs = {
                            from: ownerAddress, // get address string
                            to: contractAddress, // get the contract string
                            value: "0",
                            nonce: 0,
                            gasPrice: "200000",
                            gasLimit: "1000000",
                            contract: { "function": "getPlayersInfoByTokenId", "args": "[\"" + JSON.stringify(tokenIds) + "\"]" }
                        }
                        neb.api.call(callJSONs)
                        .then(function (resp) {
                        console.log(resp.result);
                        playerInfo = JSON.parse(resp.result);                
                        })
                        .then(function (){
                            displayPlayerInfo(playerInfo);
                        })
                    })
                .catch(function (err) {
                    console.log(JSON.stringify(err));
                });
       };


       
       function displayPlayerInfo(info) { // this is a normal function
            var playersRow = $('#playersRow');
            var playersTemplate = $('#playersTemplate');                    
            playersRow.empty();
            $.getJSON('./players.json', function(data) {
                    for (var i=0;i<info.length;i++){
                        console.log(i)
                        console.log("player name: " +data[(info[i].id)].name);
                        console.log("player talent: " +info[i].talent);
                        playersTemplate.find('#name').text(data[(info[i].id)].name);
                        playersTemplate.find('img').attr('src', data[(info[i].id)].picture);
                        playersTemplate.find('#talent').attr('class',showStars(info[i].talent))
                       // $('#talent').attr('class',showStars(info[i].talent))
                       playersTemplate.find('#goal').text(info[i].goal);
                       playersTemplate.find('#win').text(info[i].win);
                       playersTemplate.find('#playtime').text(info[i].time);
                      
                        playersTemplate.find('button').attr("id","Button"+tokenIds[i])
                        playersRow.append(playersTemplate.html());
                    }


                    for(var i = 0;i<tokenIds.length;i++){
                      //  $('#Modal'+tokenIds[i]).show().text("this is modal "+i);
                       // $('#Button'+tokenIds[i]).attr("data-target","Modal"+tokenIds[i])
                        $('#Button'+tokenIds[i]).click({ id: tokenIds[i]},function(e) {
                            e.preventDefault();
                            modalOn();
                            let temp = parseInt($(this).attr('id').substring(6));
                            console.log("here! "+ temp);
                            var id = e.data.id;
                            $('#confirm').click({ id: id},function(e){
                                e.preventDefault();
                                transfer(e.data.id);
                            });
                            // claim(temp);
                        })
                    }
            });
       }

        

        function transfer(id){
            var address = $('#toAddress').val().trim();
            if (address.substring(0, 2) !== "n1" || address.length !== 35) {
                alert('Check your address!')
                return;
            }
            var to = contractAddress;
            var value = 0;// need to change
            var callFunction = "transfer";
            var callArgs = "[\"" + address + "\"," + id+"]";
            serialNumber = nebPay.call(to, value, callFunction, callArgs, {    //使用nebpay的call接口去调用合约,
                listener: transferListener,        //设置listener, 处理交易返回信息
            });
        }


            var txhash;
            function transferListener(resp) {
                txhash = resp.txhash;
                neb.api.getTransactionReceipt({
                    hash: resp.txhash
                })
                    .then(function (receipt) {
                        spinOn();
                        console.log("receipt is:" + JSON.stringify(receipt))
                        setQuery = setInterval(function () {
                            setTxQuery();
                        }, 10000);
                    })
            }
                function setTxQuery() {
                neb.api.getTransactionReceipt({
                    hash: txhash
                })
                    .then(function (receipt) {
                        console.log(receipt)
                        if (receipt.status ==1){
                            console.log("tx success")
                            clearInterval(setQuery);
                            init();
                            spinOff();
                            $("#modal-status").text('Congratulations! You just made a successful transfer!')
                        }
                        if (receipt.status ==0){
                            console.log("tx fail")
                            spinOff();
                            clearInterval(setQuery);
                            $("#modal-status").text('Oops, something goes wrong. Transaction failed.')
                        }
                    })
                    .catch(function (err) {
                        console.log("didn't get a receipt")
                    })
            }




        function showStars(number){
            return "stars-container stars-"+number;
        }



        function modalOn(){
            console.log('in modal On')
            $("#modal-status").hide();
            $("#toAddress").attr("placeholder","type in your NAS address destination ");
            $("#modal-input").show();
            $("#confirm").show();
        }

        function spinOn() {
            $(".loader").css("display","block");
            $("#modal-input").hide();
            $("#modal-status").show().text('In transaction, please wait');
            $("#confirm").hide();
           
            // $("#claimButton").hide();
        }

        function spinOff() {
            $(".loader").css("display","none");
            // $("#claimButton").show();
        }
        
        $(window).load(function () {
            // executes when complete page is fully loaded, including all frames, objects and images
                
            // var getAccount = function (e) {
            //         e.preventDefault();
            //         if(!!e.data.data.account){
            //             account = e.data.data.account;
            //             console.log(account)
            //             window.removeEventListener("message", getAccount, false);
            //             init();
            //         } // console.log(account)
            //         else{
            //             $("#title").text("Hey there, please load your wallet or check your address");
            //             init();
            //         }
            //     };
            //     window.addEventListener('message', getAccount); 
            //     window.postMessage({
            //     "target": "contentscript",
            //     "data":{},
            //     "method": "getAccount",
            //     }, "*");       
            init();
        });
    </script>

</body>
</html>
