<!DOCTYPE html>
<html>
<head>
  <title>Join my Nebulas Team</title>
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,700' rel='stylesheet' type='text/css'>
  <link rel=stylesheet href=lib/prismjs-1.13.0/prism.css>
  <link rel="icon shortcut" href=img/logo.png type=image/png>
  <link rel=apple-touch-icon href=img/logo.png>
  <link rel=stylesheet href=lib/bootstrap-4.0.0-dist/css/bootstrap.min.css>
  <link rel=stylesheet href=css/base.css>
  <link rel=stylesheet href=css/ui-block.css>
  <meta name=viewport content="width=device-width">
</head>

<style>
        .myheader {
            text-align: center;
            color: black;
            font-size: 30px;
        }

        .ownercontainer,.usercontainer {
            overflow: hidden;
            margin: 0;
            padding: 0;
            list-style: none;
            text-align:center;
        }

        .table {
            text-align:center;
            margin : 20px;
        } 
</style>

<body>
    <div class = "myheader"> Team Building </div>
    <br>
    <div class = "ownercontainer">
            <p> Hi there!</p>
            <p>would you like to join my team ?</p>
            <p> My team is at  <span class="black"><span id="ownerAddress"></span> </span></p>
            <br>
            <p> My team has  <span class="black"><span id="teamSize"></span>  </span></p>
            <table class="table table-striped" id="here_table"> <table>
    </div>

    <br>

    <div  class = "usercontainer">
            <p><span id="userinfo">load your Nebulas Wallet first!</span></p> 
            <p><span id="useraddress"></p> 
            <button type="button" onClick="joinTeam();">join</button>
    </div>

    <br>



    <div class="container select-wallet-file"></div>
  

  <script src=lib/jquery-3.3.1.min.js></script>
  <script src=lib/bootstrap-4.0.0-dist/js/bootstrap.bundle.min.js data-depends=jquery.slim></script>
  <script src=lib/bootbox.min.js data-depends="bootstrap jquery.slim"></script>
  <script src=lib/blockies.min.js></script>
  <script src=lib/js-beautify-1.7.5/beautify.js></script>
  <script src=lib/prismjs-1.13.0/prism.js></script>
  <script src=lib/nebulas.js></script>
  <script src=js/1-localSave.js></script>
  <script src=js/home.v1.js></script>
  <script src=js/i18n.js data-depends=jquery.slim></script>
  <script src=js/ui-block.js data-depends="bootbox blockies jquery.slim i18n.js nebulas.js"></script>
  <script src=lib/codemirror/codemirror.js></script>
  <script src=lib/codemirror/javascript.js></script>


  <script>
            const contractAddress = "n1hUkunTCQEnYFk4EdYyVvMuhaKgDzv3QsV";
            const ownerAddress = "n1RQYWMLqy1twJhfYxPk4SFx7wdfeq31pMX";
            var userAccount;
            var userNonce;
            var nebulas = require("nebulas"),
            Utils = nebulas.Utils,
            Unit = nebulas.Unit,
            Account = nebulas.Account,
            globalParams = {
                account: null
            },
            neb = new nebulas.Neb()
            

            //neb.setRequest(new nebulas.HttpRequest(localSave.getItem("apiPrefix") || "https://testnet.nebulas.io/"));
            neb.setRequest(new nebulas.HttpRequest("https://testnet.nebulas.io"));
            var chainId = 1001;// test net

            uiBlock.insert({
                footer: ".footer",
                header: ".header",
                iconAddress: ".icon-address",
                logoMain: ".logo-main",
                numberComma: ".number-comma",
                selectWalletFile: [".select-wallet-file", onUnlockFile]
            });

            var testcontract = {"function":"getOwner","args":""};
            
            getOwnerAddress();
            refreshTeamSize();
            refreshTeamTable();
            

        
        function getOwnerAddress(){ // this is simply a call function
            // call the contract and get the info
            neb.api.call({
                        from: ownerAddress, // get address string
                        to: contractAddress, // get the contract string
                        value: "0",
                        nonce: 0,
                        gasPrice: "200000",
                        gasLimit: "1000000",
                        contract: testcontract
                    })
                    .then(function (resp) {
                       // let text = JSON.stringify(resp);
                        let address = resp.result;
                        console.log(address);
                        $("#ownerAddress").text(address)
                    })
                    .catch(function (err) {
                        console.log(text(JSON.stringify(err)));
                    });
        }

        function refreshTeamSize(){
            let contract = {"function":"teamSize","args":""};
            neb.api.call({
                        from: ownerAddress, // get address string
                        to: contractAddress, // get the contract string
                        value: "0",
                        nonce: 0,
                        gasPrice: "200000",
                        gasLimit: "1000000",
                        contract: contract
                    })
                    .then(function (resp) {
                       // let text = JSON.stringify(resp);
                       $("#teamSize").text(resp.result+" guys")

                    })
                    .catch(function (err) {
                        console.log(text(JSON.stringify(err)));
                    });

        }


        function refreshTeamTable(){
            let contract = {"function":"teamSize","args":""};
            neb.api.call({
                        from: ownerAddress, // get address string
                        to: contractAddress, // get the contract string
                        value: "0",
                        nonce: 0,
                        gasPrice: "200000",
                        gasLimit: "1000000",
                        contract: contract
                    })
                    .then(function (resp) {
                       // let text = JSON.stringify(resp);
                       for (i=0;i<resp.result;i++)
                       {
                        let getMemberContract = {"function":"getMember","args":"["+i+"]"};
                        console.log(getMemberContract)
                            neb.api.call({
                                from: ownerAddress, // get address string
                                to: contractAddress, // get the contract string
                                value: "0",
                                nonce: 0,
                                gasPrice: "200000",
                                gasLimit: "1000000",
                                contract: getMemberContract
                            }).then(function (resp1) {
                                console.log(JSON.stringify(resp1))
                                $('#here_table').append( '<tr><td>' +  resp1.result + '</td></tr>' );
                            })
                       }
                       

                    })
                    .catch(function (err) {
                        console.log(text(JSON.stringify(err)));
                    });

        }


        function joinTeam(){
            var joincontract = {"function":"joinTeam","args":""};
            innerCall(function(params) {
                params.contract = joincontract;
                var gTx = new nebulas.Transaction(1001,
                    globalParams.account,
                    params.to, params.value, params.nonce, params.gasPrice, params.gasLimit, params.contract);
                
                console.log(params.gasPrice)
                gTx.signTransaction();
                console.log("ok so far")
                var txHash;
                neb.api
                    .sendRawTransaction(gTx.toProtoString())
                    .then(function (resp) {
                        console.log(JSON.stringify(resp));
                        $("#call_result").text(JSON.stringify(resp));
                        txHash = resp.txhash;
                        console.log(txHash)
                        console.log("great!");
                        neb.api
                            .getTransactionReceipt(resp.txhash)
                            .then(function (resp1) {
                                console.log(JSON.stringify(resp1))
                                refreshTeamSize();
                            });
                        
                    })
                    .catch(function (err) {
                        console.log(err)
                    });


                        
                
            })
            
            


        }



        function onUnlockFile(swf, fileJson, account, password) {  //TODO: 对外函数不要用简称
            var address;
            try {
                account.fromKey(fileJson, password);
                address = account.getAddressString();
                gAccount = account;

                globalParams.account = account;

                $(".icon-address.from input").val(address).trigger("input"); // gen icon from addr, needs trigger 'input' event if via set o.value
                $("#unlock").hide();
                $("#send").show();

                userAccount = gAccount
                $("#userinfo").text("wallet load successfully");
                $("#useraddress").text("your address is at " + address);
                neb.api.getAccountState(address)
                    .then(function (resp) {
                        
                        var nas = Unit.fromBasic(resp.balance, "nas").toNumber();
                        userNonce = parseInt(resp.nonce) + 1;
                        //
                        $("#balance").val(nas).trigger("input"); // add comma & unit from value, needs trigger 'input' event if via set o.value
                        $("#nonce").val(parseInt(resp.nonce || 0) + 1);
                    })
                    .catch(function (e) {
                        // this catches e thrown by nebulas.js!neb

                        bootbox.dialog({
                            backdrop: true,
                            onEscape: true,
                            message: i18n.apiErrorToText(e.message),
                            size: "large",
                            title: "Error"
                        });
                    });
            } catch (e) {
                // this catches e thrown by nebulas.js!account

                bootbox.dialog({
                    backdrop: true,
                    onEscape: true,
                    message: localSave.getItem("lang") == "en" ? e : "keystore 文件错误, 或者密码错误",
                    size: "large",
                    title: "Error"
                });
            }
        }


        function innerCall(callback) {
            let params = {};

            if (!globalParams.account) {
                // TODO 提示钱包信息不正确
                return;
            }
            params.from = globalParams.account.getAddressString();

            // prepare to
            let toAddr = contractAddress
            if (!Account.isValidAddress(toAddr)) {
                $("#run_to_addr").addClass("err");
                setTimeout(function () {
                    $("#run_to_addr").removeClass("err");
                }, 5000);
                return;
            }
            params.to = toAddr;

            // prepare gasLimit
            let gasLimit = Utils.toBigNumber(0);
            params.gasLimit = 200000;



            // prepare gasPrice
            neb.api.gasPrice().then(function(resp){
                params.gasPrice = resp.gas_price;
            })


            // prepare value
            let value = Utils.toBigNumber(0);
            params.value = value;

            // prepare contract
            

            // prepare nonce
            // needs refresh data on every 'test' and 'commit' call, because data update may slow,
            // you can get different result by hit 'test' multiple times
            neb.api.getAccountState(params.from).then(function (resp) {
                var balance = nebulas.Unit.fromBasic(resp.balance, "nas")
                params.nonce = parseInt(resp.nonce) + 1;

                callback(params);
            }).catch(function (err) {
                // console.log("prepare nonce error: " + err);
                bootbox.dialog({
                    backdrop: true,
                    onEscape: true,
                    message: i18n.apiErrorToText(err.message),
                    size: "large",
                    title: "Error"
                });
            });
        }


  </script>

</body>


</html>
